name: Weekly Newsletter

# Runs every Sunday at 9 AM UTC
on:
  schedule:
    - cron: '0 9 * * 0'  # Sunday at 9 AM UTC
  # Also allow manual triggering
  workflow_dispatch:

jobs:
  send-weekly-newsletter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install @supabase/supabase-js @emailjs/nodejs
        
    - name: Send weekly newsletter
      env:
        SUPABASE_URL: 'https://nofpllfekouldgxgyunu.supabase.co'
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vZnBsbGZla291bGRneGd5dW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzcwNDQsImV4cCI6MjA3ODQ1MzA0NH0.KfmYheXhjnG7Q9OWC6PiAr8IW38VlXRCXJnpQJIV1AM'
        EMAILJS_SERVICE_ID: 'service_fgmh6c5'
        EMAILJS_TEMPLATE_ID: 'template_zmw8pd9'
        EMAILJS_PUBLIC_KEY: 'Aol5sZm8-YIcx43oi'
        EMAILJS_PRIVATE_KEY: 'PFdL6M9xONS55-rIEl0eh'
      run: |
        node -e "
        const { createClient } = require('@supabase/supabase-js');
        const emailjs = require('@emailjs/nodejs');
        const fs = require('fs');
        
        async function sendWeeklyNewsletter() {
          try {
            console.log('üöÄ Starting newsletter process...');
            console.log('Environment check:');
            console.log('SUPABASE_URL:', process.env.SUPABASE_URL ? 'Set' : 'Missing');
            console.log('SUPABASE_KEY:', process.env.SUPABASE_KEY ? 'Set' : 'Missing');
            console.log('EMAILJS_SERVICE_ID:', process.env.EMAILJS_SERVICE_ID ? 'Set' : 'Missing');
            console.log('EMAILJS_TEMPLATE_ID:', process.env.EMAILJS_TEMPLATE_ID ? 'Set' : 'Missing');
            console.log('EMAILJS_PUBLIC_KEY:', process.env.EMAILJS_PUBLIC_KEY ? 'Set' : 'Missing');
            console.log('EMAILJS_PRIVATE_KEY:', process.env.EMAILJS_PRIVATE_KEY ? 'Set' : 'Missing');
            
            // Load and filter blog posts from the past week
            console.log('üìö Loading blog posts...');
            const blogPostsData = JSON.parse(fs.readFileSync='public/blog-posts.json', 'utf8');
            
            // Get current date and one week ago
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Filter published posts from the past week
            const recentPosts = blogPostsData.posts.filter(post => {
              if (!post.published || !post.dateFormatted) return false;
              
              // Parse the date format (MM.DD.YYYY)
              const [month, day, year] = post.dateFormatted.split('.');
              const postDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
              
              return postDate >= oneWeekAgo && postDate <= now;
            });
            
            console.log(\`Found \${recentPosts.length} posts from the past week\`);
            
            // Generate message with blog post links
            let message = '';
            if (recentPosts.length > 0) {
              const postLinks = recentPosts.map(post => 
                \`üìù <a href=\"https://abbydanger.com/blog/\${post.slug}\" style=\"color: #2c5f73; text-decoration: underline;\">\${post.title}</a>\`
              ).join('<br>');
              
              message = \`<p>Here's what I wrote about on the blog this week:</p>
              <p>\${postLinks}</p>
              <p>Read more at <a href=\"abbydanger.com/blog\" target=\"_blank\" rel=\"noopener\" style=\"color: #2c5f73; text-decoration: underline;\">abbydanger.com/blog</a></p>\`;
            } else {
              message = \`<p>No new posts this week, but maybe next week ... if I feel like it üòâ</p>
              <p>Read more at <a href=\"abbydanger.com/blog\" target=\"_blank\" rel=\"noopener\" style=\"color: #2c5f73; text-decoration: underline;\">abbydanger.com/blog</a></p>\`;
            }
            
            // Initialize Supabase
            const supabase = createClient(
              process.env.SUPABASE_URL, 
              process.env.SUPABASE_KEY
            );
            
            // Get all subscribers
            const { data: subscribers, error } = await supabase
              .from('emails')
              .select('email');
            
            if (error) {
              console.error('Supabase error:', error);
              throw error;
            }
            
            console.log(\`üìß Found \${subscribers?.length || 0} subscribers\`);
            if (subscribers && subscribers.length > 0) {
              console.log('Subscriber emails:', subscribers.map(s => s.email));
            }
            
            let sent = 0;
            let failed = 0;
            
            // Send emails in batches
            const batchSize = 5;
            for (let i = 0; i < subscribers.length; i += batchSize) {
              const batch = subscribers.slice(i, i + batchSize);
              
              const batchPromises = batch.map(async (subscriber) => {
                try {
                  console.log(\`Sending to: \${subscriber.email}\`);
                  console.log(\`Using Service ID: \${process.env.EMAILJS_SERVICE_ID}\`);
                  console.log(\`Using Template ID: \${process.env.EMAILJS_TEMPLATE_ID}\`);
                  
                  const result = await emailjs.send(
                    process.env.EMAILJS_SERVICE_ID,
                    process.env.EMAILJS_TEMPLATE_ID,
                    {
                      to_email: subscriber.email,
                      subject: 'Weekly Blog Update from Abby Danger',
                      message: message,
                      from_name: 'Abby Danger'
                    },
                    {
                      publicKey: process.env.EMAILJS_PUBLIC_KEY,
                      privateKey: process.env.EMAILJS_PRIVATE_KEY,
                    }
                  );
                  
                  console.log(\`  ‚úì \${subscriber.email} - Result:\`, result);
                  sent++;
                } catch (emailError) {
                  console.error(\`  ‚úó \${subscriber.email}: \${emailError.message || 'Unknown error'}\`);
                  console.error('Full error object:', JSON.stringify(emailError, null, 2));
                  console.error('Error name:', emailError.name);
                  console.error('Error status:', emailError.status);
                  console.error('Error text:', emailError.text);
                  failed++;
                }
              });
              
              await Promise.all(batchPromises);
              
              // Add delay between batches
              if (i + batchSize < subscribers.length) {
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
            }
                        
          } catch (error) {
            console.error('‚ùå Error sending weekly newsletter:', error);
            process.exit(1);
          }
        }
        
        sendWeeklyNewsletter();
        "